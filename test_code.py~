# -*- coding: utf-8 -*-
"""
Created on Thu Sep 29 00:09:39 2022

@author: Himanshu Tyagi
"""
# Form implementation generated from reading ui file 'sign_up.ui'
# Created by: PyQt5 UI code generator 5.15.7
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.



from astropy import log
from astropy.coordinates import Angle, SkyCoord
from astropy.visualization import AsymmetricPercentileInterval
from regions import RectangleSkyRegion
from astropy.wcs import WCS
from astropy.io import fits
import matplotlib.pyplot as plt
from astroquery.skyview import SkyView
import astropy.units as u
from astropy.nddata import Cutout2D
from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QMessageBox
import sys
from PyQt5.QtWidgets import QDialog, QApplication, QPushButton, QVBoxLayout, QHeaderView, QTabWidget
from PyQt5.QtCore import pyqtSignal, pyqtSlot, QObject, QThread, QTimer
from matplotlib.backends.backend_qt5agg import FigureCanvas
from matplotlib.backends.backend_qt5agg import NavigationToolbar2QT
from matplotlib.figure import Figure
from matplotlib.colors import LogNorm
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg, NavigationToolbar2QT as Navi
import sip
import pandas as pd
from scipy import ndimage, misc
from astropy.visualization.interval import (PercentileInterval,
                                            AsymmetricPercentileInterval,
                                            ManualInterval, MinMaxInterval)

from astropy.visualization.stretch import (LinearStretch, SqrtStretch,
                                           PowerStretch, LogStretch,
                                           AsinhStretch)

from astropy.visualization.mpl_normalize import ImageNormalize
import threading
import numpy as np
#%%
y = 70


class MatplotlibCanvas(FigureCanvasQTAgg):
	def __init__(self,parent=None, dpi = 120):
		self.fig = Figure(figsize=[10,10], dpi = dpi)
		#self.axes = fig.add_subplot(111)

		super(MatplotlibCanvas,self).__init__(self.fig)
		#self.fig.set_positions(0.2, 0.2, 0.8, 0.8) # left,bottom,width,height
	#fig.tight_layout()    



def simple_norm(data, stretch='linear', power=1.0, asinh_a=0.1, log_a=1000,
                min_cut=None, max_cut=None, min_percent=None, max_percent=None,
                percent=None, clip=True):

    if percent is not None:
        interval = PercentileInterval(percent)
    elif min_percent is not None or max_percent is not None:
        interval = AsymmetricPercentileInterval(min_percent or 0.,
                                                max_percent or 100.)
    elif min_cut is not None or max_cut is not None:
        interval = ManualInterval(min_cut, max_cut)
    else:
        interval = MinMaxInterval()

    if stretch == 'linear':
        stretch = LinearStretch()
    elif stretch == 'sqrt':
        stretch = SqrtStretch()
    elif stretch == 'power':
        stretch = PowerStretch(power)
    elif stretch == 'log':
        stretch = LogStretch(log_a)
    elif stretch == 'asinh':
        stretch = AsinhStretch(asinh_a)
    else:
        raise ValueError('Unknown stretch: {0}.'.format(stretch))

    vmin, vmax = interval.get_limits(data)

    return ImageNormalize(vmin=vmin, vmax=vmax, stretch=stretch, clip=clip)


def rotate(p, origin=(0, 0), degrees=0):
    angle = np.deg2rad(degrees)
    R = np.array([[np.cos(angle), -np.sin(angle)],
                  [np.sin(angle),  np.cos(angle)]])
    o = np.atleast_2d(origin)
    p = np.atleast_2d(p)
    return np.squeeze((R @ (p.T-o.T) + o.T).T)


class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(1480, 1000)
        MainWindow.setFocusPolicy(QtCore.Qt.TabFocus)
        MainWindow.setStyleSheet("\n"
                                 "\n"
                                 "background-color: rgb(255,255,255);\n"
                                 "font: 14pt \"Times\";")
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")

        self.tabWidget = QtWidgets.QTabWidget(self.centralwidget)
        self.tabWidget.setGeometry(QtCore.QRect(10, 10, 1480, 1000))
        self.tabWidget.setObjectName("tabWidget")
        self.tab_3 = QtWidgets.QWidget()
        self.tab_3.setObjectName("tab_3")

        self.label = QtWidgets.QLabel(self.tab_3)
        self.label.setGeometry(QtCore.QRect(120, y+70*0, 131, 31))
        self.label.setObjectName("label")
        

        self.textEdit = QtWidgets.QLineEdit(self.tab_3)
        self.textEdit.setGeometry(QtCore.QRect(280, y+ 0*70, 371, 41))
        self.textEdit.setObjectName("textEdit")
        self.textEdit.setToolTip("Enter simbad searchable name")
        
        
        self.coords_label = QtWidgets.QLabel(self.tab_3)
        self.coords_label.setGeometry(QtCore.QRect(120, y+70*1, 131, 31))
        self.coords_label.setObjectName("coords_label")
        
        
        self.coords = QtWidgets.QLineEdit(self.tab_3)
        self.coords.setGeometry(QtCore.QRect(280, y+70*1, 371, 41))
        self.coords.setObjectName("coords")
        self.coords.setToolTip("Enter Coordinates (Optional, if Object name is given.)")
        
        
        self.field_rotation_value = QtWidgets.QLineEdit(self.tab_3)
        self.field_rotation_value.setGeometry(QtCore.QRect(280, y+70*2, 371, 41))
        self.field_rotation_value.setObjectName("field_rotation")
        self.field_rotation_value.setToolTip("Enter field rotation angle in degrees")
        
        
        self.field_rotation = QtWidgets.QLabel(self.tab_3)
        self.field_rotation.setGeometry(QtCore.QRect(120, y+70*2, 131, 31))
        self.field_rotation.setObjectName("field_rotation_value")
        
        
        self.label_filename = QtWidgets.QLabel(self.tab_3)
        self.label_filename.setGeometry(QtCore.QRect(120, y+70*3, 131, 31))
        self.label_filename.setObjectName("label")
        
        self.textEdit_filename = QtWidgets.QLineEdit(self.tab_3)
        self.textEdit_filename.setGeometry(QtCore.QRect(280, y+70*3, 250, 41))
        self.textEdit_filename.setObjectName("textEdit_filename")
        self.textEdit_filename.setToolTip("Optional (overrides Target Name)")

        self.file_upload = QtWidgets.QPushButton(self.tab_3)
        self.file_upload.setGeometry(QtCore.QRect(531, y+70*3, 120, 41))
        self.file_upload.setIcon( QtGui.QIcon("upload2.png"))
        self.file_upload.setObjectName("file_upload")
        self.file_upload.setToolTip("Upload a .fits file")
        
        
        self.target_list_fname = QtWidgets.QLabel(self.tab_3)
        self.target_list_fname.setGeometry(QtCore.QRect(120, y+70*4, 131, 31))
        self.target_list_fname.setObjectName("target_list_fname")
        
        self.target_list = QtWidgets.QLineEdit(self.tab_3)
        self.target_list.setGeometry(QtCore.QRect(280, y+70*4, 250, 41))
        self.target_list.setObjectName("target_list")
        self.target_list.setToolTip("Displays Targets in FOV (optional)")
        
        self.load_targets = QtWidgets.QPushButton(self.tab_3)
        self.load_targets.setGeometry(QtCore.QRect(531, y+70*4, 120, 41))
        self.load_targets.setIcon( QtGui.QIcon("csv.png"))
        self.load_targets.setObjectName("load_targets")
        self.load_targets.setToolTip("Load target list")  
        

        self.label_2 = QtWidgets.QLabel(self.tab_3)
        self.label_2.setGeometry(QtCore.QRect(120, y+70*5, 180, 120))
        self.label_2.setObjectName("label_2")

        
        self.tableWidget = QtWidgets.QTableWidget(self.tab_3)
        self.tableWidget.setGeometry(QtCore.QRect(377, y+70*5, 275, 225))
        self.tableWidget.setObjectName("tableWidget")
        self.tableWidget.setColumnCount(2)
        self.tableWidget.setRowCount(5)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setVerticalHeaderItem(0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setVerticalHeaderItem(1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setVerticalHeaderItem(2, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setVerticalHeaderItem(3, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setVerticalHeaderItem(4, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.horizontalHeader().setStretchLastSection(True)
        self.tableWidget.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.tableWidget.verticalHeader().setStretchLastSection(True)
        self.tableWidget.verticalHeader().setSectionResizeMode(QHeaderView.Stretch)
        
        self.tableWidget.setHorizontalHeaderItem(0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setHorizontalHeaderItem(1, item)



        self.pushButton_5 = QtWidgets.QPushButton(self.tab_3)
        self.pushButton_5.setGeometry(QtCore.QRect(377, y+580, 275, 41))
        self.pushButton_5.setObjectName("pushButton_5")
        self.pushButton_5.setToolTip("Plot slit configuration over sky image")
        
        
        self.label_Temp = QtWidgets.QLabel(self.tab_3)
        self.label_Temp.setGeometry(QtCore.QRect(120, y+70*10, 131, 31))
        self.label_Temp.setObjectName("Temperature")
        
        self.lcdNumber = QtWidgets.QLCDNumber(self.tab_3)
        self.lcdNumber.setGeometry(QtCore.QRect(300, y+70*10, 161, 61))
        self.lcdNumber.setFocusPolicy(QtCore.Qt.NoFocus)
        self.lcdNumber.setStyleSheet("color: rgb(255, 0, 0);")
        self.lcdNumber.setInputMethodHints(QtCore.Qt.ImhNoEditMenu)
        self.lcdNumber.setSegmentStyle(QtWidgets.QLCDNumber.Filled)
        self.lcdNumber.setProperty("intValue", 0)
        self.lcdNumber.setObjectName("lcdNumber")
        
        
        self.gridLayoutWidget = QtWidgets.QWidget(self.tab_3)
        self.gridLayoutWidget.setGeometry(QtCore.QRect(750,y,700,700))
        self.gridLayoutWidget.setObjectName("gridLayoutWidget")
        self.gridLayout = QtWidgets.QGridLayout(self.gridLayoutWidget)
        self.gridLayout.setContentsMargins(0, 0, 0, 0)
        self.gridLayout.setObjectName("gridLayout")

        
        MainWindow.setCentralWidget(self.tab_3)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)

        self.gridLayout.setObjectName("gridLayout")        
        self.horizontalLayout = QtWidgets.QHBoxLayout()
        self.horizontalLayout.setObjectName("horizontalLayout")
        self.spacerItem = QtWidgets.QSpacerItem(40, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Minimum)
        self.horizontalLayout.addItem(self.spacerItem)
        self.gridLayout.addLayout(self.horizontalLayout, 0, 0, 1, 1)
        
        
        self.verticalLayout = QtWidgets.QVBoxLayout()
        self.verticalLayout.setObjectName("verticalLayout")
        self.spacerItem1 = QtWidgets.QSpacerItem(40, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Minimum)
        self.verticalLayout.addItem(self.spacerItem1)
        self.gridLayout.addLayout(self.verticalLayout, 1, 0, 1, 1)

        
        #self.test = QtWidgets.QPushButton(self.tab_3)
        #self.test.setGeometry(QtCore.QRect(377, y+70*9, 275, 41))
        #self.test.setObjectName("test")
        #self.test.setToolTip("Plot slit configuration over sky image")

        

        
        self.canv = MatplotlibCanvas(self)
        self.toolbar = Navi(self.canv,self.tab_3)
        self.horizontalLayout.addWidget(self.toolbar)
        
        self.pushButton_5.clicked.connect(self.plot_table)
        
        self.file_upload.clicked.connect(self.open_file)    
        self.load_targets.clicked.connect(self.open_target)    
        
        #self.test.clicked.connect(self.start_thread)
        
        self.tabWidget.addTab(self.tab_3, "")

########   TAB ENG  #########################################################
        self.tab_4 = QtWidgets.QWidget()

        self.eng_label = QtWidgets.QLabel(self.tab_4)
        self.eng_label.setGeometry(QtCore.QRect(120, y+70*0, 131, 31))
        self.eng_label.setObjectName("label")
        

        self.eng_textEdit = QtWidgets.QLineEdit(self.tab_4)
        self.eng_textEdit.setGeometry(QtCore.QRect(280, y+ 0*70, 371, 41))
        self.eng_textEdit.setObjectName("textEdit")
        self.eng_textEdit.setToolTip("Enter simbad searchable name")
        
        
        self.eng_coords_label = QtWidgets.QLabel(self.tab_4)
        self.eng_coords_label.setGeometry(QtCore.QRect(120, y+70*1, 131, 31))
        self.eng_coords_label.setObjectName("coords_label")
        
        
        self.eng_coords = QtWidgets.QLineEdit(self.tab_4)
        self.eng_coords.setGeometry(QtCore.QRect(280, y+70*1, 371, 41))
        self.eng_coords.setObjectName("coords")
        self.eng_coords.setToolTip("Enter Coordinates (Optional, if Object name is given.)")
        
        
        self.eng_label_filename = QtWidgets.QLabel(self.tab_4)
        self.eng_label_filename.setGeometry(QtCore.QRect(120, y+70*2, 131, 31))
        self.eng_label_filename.setObjectName("label")
        
        self.eng_textEdit_filename = QtWidgets.QLineEdit(self.tab_4)
        self.eng_textEdit_filename.setGeometry(QtCore.QRect(280, y+70*2, 250, 41))
        self.eng_textEdit_filename.setObjectName("textEdit_filename")
        self.eng_textEdit_filename.setToolTip("Optional (overrides Target Name)")

        self.eng_file_upload = QtWidgets.QPushButton(self.tab_4)
        self.eng_file_upload.setGeometry(QtCore.QRect(531, y+70*2, 120, 41))
        self.eng_file_upload.setIcon( QtGui.QIcon("upload2.png"))
        self.eng_file_upload.setObjectName("file_upload")
        self.eng_file_upload.setToolTip("Upload a .fits file")
        
        
        self.eng_target_list_fname = QtWidgets.QLabel(self.tab_4)
        self.eng_target_list_fname.setGeometry(QtCore.QRect(120, y+70*3, 131, 31))
        self.eng_target_list_fname.setObjectName("target_list_fname")
        
        self.eng_target_list = QtWidgets.QLineEdit(self.tab_4)
        self.eng_target_list.setGeometry(QtCore.QRect(280, y+70*3, 250, 41))
        self.eng_target_list.setObjectName("target_list")
        self.eng_target_list.setToolTip("Displays Targets in FOV (optional)")
        
        self.eng_load_targets = QtWidgets.QPushButton(self.tab_4)
        self.eng_load_targets.setGeometry(QtCore.QRect(531, y+70*3, 120, 41))
        self.eng_load_targets.setIcon( QtGui.QIcon("csv.png"))
        self.eng_load_targets.setObjectName("load_targets")
        self.eng_load_targets.setToolTip("Load target list")  
        

        self.eng_label_2 = QtWidgets.QLabel(self.tab_4)
        self.eng_label_2.setGeometry(QtCore.QRect(120, y+70*4, 180, 120))
        self.eng_label_2.setObjectName("label_2")

        
        self.eng_tableWidget = QtWidgets.QTableWidget(self.tab_4)
        self.eng_tableWidget.setGeometry(QtCore.QRect(377, y+70*4, 275, 225))
        self.eng_tableWidget.setObjectName("tableWidget")
        self.eng_tableWidget.setColumnCount(2)
        self.eng_tableWidget.setRowCount(5)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.setVerticalHeaderItem(0, item)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.setVerticalHeaderItem(1, item)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.setVerticalHeaderItem(2, item)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.setVerticalHeaderItem(3, item)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.setVerticalHeaderItem(4, item)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.horizontalHeader().setStretchLastSection(True)
        self.eng_tableWidget.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.eng_tableWidget.verticalHeader().setStretchLastSection(True)
        self.eng_tableWidget.verticalHeader().setSectionResizeMode(QHeaderView.Stretch)
        
        self.eng_tableWidget.setHorizontalHeaderItem(0, item)
        item = QtWidgets.QTableWidgetItem()
        self.eng_tableWidget.setHorizontalHeaderItem(1, item)



        self.eng_pushButton_5 = QtWidgets.QPushButton(self.tab_4)
        self.eng_pushButton_5.setGeometry(QtCore.QRect(377, y+70*8, 275, 41))
        self.eng_pushButton_5.setObjectName("pushButton_5")
        self.eng_pushButton_5.setToolTip("Plot slit configuration over sky image")
        
        
        self.eng_label_Temp = QtWidgets.QLabel(self.tab_4)
        self.eng_label_Temp.setGeometry(QtCore.QRect(120, y+70*9, 131, 31))
        self.eng_label_Temp.setObjectName("Temperature")
        
        self.eng_lcdNumber = QtWidgets.QLCDNumber(self.tab_4)
        self.eng_lcdNumber.setGeometry(QtCore.QRect(300, y+70*9, 161, 61))
        self.eng_lcdNumber.setFocusPolicy(QtCore.Qt.NoFocus)
        self.eng_lcdNumber.setStyleSheet("color: rgb(255, 0, 0);")
        self.eng_lcdNumber.setInputMethodHints(QtCore.Qt.ImhNoEditMenu)
        self.eng_lcdNumber.setSegmentStyle(QtWidgets.QLCDNumber.Filled)
        self.eng_lcdNumber.setProperty("intValue", 0)
        self.eng_lcdNumber.setObjectName("lcdNumber")
        
        
        self.eng_gridLayoutWidget = QtWidgets.QWidget(self.tab_4)
        self.eng_gridLayoutWidget.setGeometry(QtCore.QRect(750,y,661,661))
        self.eng_gridLayoutWidget.setObjectName("gridLayoutWidget")
        self.eng_gridLayout = QtWidgets.QGridLayout(self.eng_gridLayoutWidget)
        self.eng_gridLayout.setContentsMargins(0, 0, 0, 0)
        self.eng_gridLayout.setObjectName("gridLayout")

        
        MainWindow.setCentralWidget(self.tab_4)
        self.eng_statusbar = QtWidgets.QStatusBar(MainWindow)
        self.eng_statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.eng_statusbar)

        self.eng_gridLayout.setObjectName("gridLayout")        
        self.eng_horizontalLayout = QtWidgets.QHBoxLayout()
        self.eng_horizontalLayout.setObjectName("horizontalLayout")
        self.eng_spacerItem = QtWidgets.QSpacerItem(40, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Minimum)
        self.eng_horizontalLayout.addItem(self.eng_spacerItem)
        self.eng_gridLayout.addLayout(self.eng_horizontalLayout, 0, 0, 1, 1)
        
        
        self.eng_verticalLayout = QtWidgets.QVBoxLayout()
        self.eng_verticalLayout.setObjectName("verticalLayout")
        self.eng_spacerItem1 = QtWidgets.QSpacerItem(40, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Minimum)
        self.eng_verticalLayout.addItem(self.eng_spacerItem1)
        self.eng_gridLayout.addLayout(self.eng_verticalLayout, 1, 0, 1, 1)

        
        #self.eng_test = QtWidgets.QPushButton(self.tab_4)
        #self.eng_test.setGeometry(QtCore.QRect(377, y+70*9, 275, 41))
        #self.eng_test.setObjectName("test")
        #self.eng_test.setToolTip("Plot slit configuration over sky image")

        

        
        self.eng_canv = MatplotlibCanvas(self)
        self.eng_toolbar = Navi(self.eng_canv,self.tab_4)
        self.eng_horizontalLayout.addWidget(self.eng_toolbar)
        
        self.eng_pushButton_5.clicked.connect(self.eng_plot_table)
        
        self.eng_file_upload.clicked.connect(self.eng_open_file)    
        self.eng_load_targets.clicked.connect(self.eng_open_target)    
        
        #self.eng_test.clicked.connect(self.start_thread)
        
        self.tabWidget.addTab(self.tab_4, "")
        #######################################################################
        
        MainWindow.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)
        
        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)
        
    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))
        self.label.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Target name</span></p></body></html>"))
        self.coords_label.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Coordinates</span></p></body></html>"))
        self.label_filename.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">File name</span></p></body></html>"))
        self.label_2.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Slit Configurations <br> (Enter in arcsec) </span></p></body></html>"))
        self.target_list_fname.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Target list</span></p></body></html>"))
        
        self.label_Temp.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:black;\">Temperature</span></p><p><br/></p></body></html>"))
        
        self.field_rotation.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Field Rotation</span></p></body></html>"))
        
        #self.pushButton_2.setText(_translate("MainWindow", "SUM"))
        #self.pushButton_3.setText(_translate("MainWindow", "Multiply"))
        #self.pushButton_4.setText(_translate("MainWindow", "Clear"))
        item = self.tableWidget.verticalHeaderItem(0)
        item.setText(_translate("MainWindow", "0"))
        item = self.tableWidget.verticalHeaderItem(1)
        item.setText(_translate("MainWindow", "1"))
        item = self.tableWidget.verticalHeaderItem(2)
        item.setText(_translate("MainWindow", "2"))

        item = self.tableWidget.verticalHeaderItem(3)
        item.setText(_translate("MainWindow", "3"))
        item = self.tableWidget.verticalHeaderItem(4)
        item.setText(_translate("MainWindow", "4"))
        
        item = self.tableWidget.horizontalHeaderItem(0)
        item.setText(_translate("MainWindow", "Slit Width"))
        item = self.tableWidget.horizontalHeaderItem(1)
        item.setText(_translate("MainWindow", "Offset"))
        self.pushButton_5.setText(_translate("MainWindow", "Load FOV"))
        #self.test.setText(_translate("MainWindow", "Load 2MASS Image"))
        
        #######################################################################
        self.eng_label.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Target name</span></p></body></html>"))
        self.eng_coords_label.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Coordinates</span></p></body></html>"))
        self.eng_label_filename.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">File name</span></p></body></html>"))
        self.eng_label_2.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Slit Configurations <br> (Enter in arcsec) </span></p></body></html>"))
        self.eng_target_list_fname.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:#000000;\">Target list</span></p></body></html>"))
        
        self.eng_label_Temp.setText(_translate("MainWindow", "<html><head/><body><p><span style=\" color:black;\">Temperature</span></p><p><br/></p></body></html>"))
        #self.eng_pushButton_2.setText(_translate("MainWindow", "SUM"))
        #self.eng_pushButton_3.setText(_translate("MainWindow", "Multiply"))
        #self.eng_pushButton_4.setText(_translate("MainWindow", "Clear"))
        item = self.eng_tableWidget.verticalHeaderItem(0)
        item.setText(_translate("MainWindow", "0"))
        item = self.eng_tableWidget.verticalHeaderItem(1)
        item.setText(_translate("MainWindow", "1"))
        item = self.eng_tableWidget.verticalHeaderItem(2)
        item.setText(_translate("MainWindow", "2"))

        item = self.eng_tableWidget.verticalHeaderItem(3)
        item.setText(_translate("MainWindow", "3"))
        item = self.eng_tableWidget.verticalHeaderItem(4)
        item.setText(_translate("MainWindow", "4"))
        
        item = self.eng_tableWidget.horizontalHeaderItem(0)
        item.setText(_translate("MainWindow", "Slit Width"))
        item = self.eng_tableWidget.horizontalHeaderItem(1)
        item.setText(_translate("MainWindow", "Offset"))
        self.eng_pushButton_5.setText(_translate("MainWindow", "Load FOV"))
        #self.eng_test.setText(_translate("MainWindow", "Load 2MASS Image"))
        
        #########################################
        self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_3), _translate("MainWindow", "Astronomers"))
        self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_4), _translate("MainWindow", "Engineers"))
        



class MainWindow(QtWidgets.QMainWindow, Ui_MainWindow):
    

    def __init__(self, parent=None):
        super(MainWindow, self).__init__(parent)
        self.threadpool = QtCore.QThreadPool()
        self.worker_thread = WorkerThread()
        self.worker_thread.job_done.connect(self.on_job_done)
        self.setupUi(self)


    def open_file(self):
            self.filename = QtWidgets.QFileDialog.getOpenFileName(None, 'Open File', '*.fits')
            print(self.filename[0])
            self.textEdit_filename.setText(self.filename[0])
        
    def open_target(self):
            self.filename = QtWidgets.QFileDialog.getOpenFileName(None, 'Open File', '*.csv')
            print(self.filename[0])
            self.target_list.setText(self.filename[0])


    def eng_open_file(self):
            self.filename = QtWidgets.QFileDialog.getOpenFileName(None, 'Open File', '*.fits')
            print(self.filename[0])
            self.eng_textEdit_filename.setText(self.filename[0])
        
    def eng_open_target(self):
            self.filename = QtWidgets.QFileDialog.getOpenFileName(None, 'Open File', '*.csv')
            print(self.filename[0])
            self.eng_target_list.setText(self.filename[0])

    def multiply(self):
        a = self.plainTextEdit_2.toPlainText()
        b = self.plainTextEdit_3.toPlainText()

        try:
            c = int(a)*int(b)
            self.lcdNumber.display(c)
        except:
            print("Invalid Inputs")
          
    #@pyqtSlot()
    def plot_table(self, vmin=None, vmid=None, vmax=None, pmin=0.25, pmax=99.75, 
                   stretch='linear', exponent=2):
        try:
            source_check = self.textEdit.text()
            coord_check = self.coords.text()
            
            if len(coord_check)!=0:
                coord_string = self.coords.text()
                try:
                    coord = SkyCoord(coord_string, frame="icrs")
                    
                except:
                    coord = SkyCoord(coord_string, frame="icrs", unit=(u.hourangle, u.deg))
                    
                
                
                
            else:
                source = self.textEdit.text()                           
                coord = SkyCoord.from_name(source, frame = 'icrs')
                print('Coordinates of the requested objects are: ',coord.ra, coord.dec)
                #self.coords.setText(f"{str(coord.ra), str(coord.dec)}")
    
            file_name = self.textEdit_filename.text()
    
            if len(file_name) != 0:
                hdu = fits.open(file_name)

                if len(hdu)==0:
                        hdu = fits.open(file_name)[0]
                else:
                        hdu = fits.open(file_name)[1]
                
                wcs = WCS(hdu.header)
                
            elif len(file_name) !=0 and len(source_check)==0:
                # hdu = fits.open(file_name)[0]

                hdu = fits.open(file_name)

                if len(hdu)==0:
                        hdu = fits.open(file_name)[0]
                else:
                        hdu = fits.open(file_name)[1]
                        
                wcs = WCS(hdu.header).celestial
                coord_string = self.coords.text()
                coord = SkyCoord(coord_string, frame="icrs")
                
            elif len(source_check)==0 and len(coord_check)!=0 and len(file_name)==0:
                paths = SkyView.get_images(position=coord, height=14*u.arcmin,  width=14*u.arcmin,
                                        survey=['2MASS-K'])
                hdu = paths[0][0]
                wcs = WCS(hdu.header).celestial
                
            else:    
                paths = SkyView.get_images(position=source, height=14*u.arcmin,  width=14*u.arcmin,
                                        survey=['2MASS-K'])
                hdu = paths[0][0]
                wcs = WCS(hdu.header).celestial

            try:
                self.horizontalLayout.removeWidget(self.toolbar)
                self.verticalLayout.removeWidget(self.canv)
                sip.delete(self.toolbar)
                sip.delete(self.canv)
                self.toolbar = None         
                self.canv = None
                self.verticalLayout.removeItem(self.spacerItem1)
                
            except Exception as e:
                print(e)
                pass
            # self.label_6.pixmap(QtGui.QPixmap(fg))
            self.canv = MatplotlibCanvas(self)
            self.toolbar = Navi(self.canv,self.tab_3)
            self.horizontalLayout.addWidget(self.toolbar)
            self.verticalLayout.addWidget(self.canv)
            # self.canv.axes.cla()
            self.canv.fig

            #ax = self.canv.fig.add_subplot(111, projection=wcs)
            ax = self.canv.fig.add_subplot(111,)
            
            min_auto = vmin is None
            max_auto = vmax is None

            if min_auto or max_auto:
                interval = AsymmetricPercentileInterval(pmin, pmax,
                                                        n_samples=10000)

                try:
                    vmin_auto, vmax_auto = interval.get_limits(hdu.data)
                except (IndexError, TypeError):  # no valid values
                    vmin_auto = vmax_auto = 0

                vmin = vmin_auto
                vmax = vmax_auto

            # Prepare normalizer object
            if stretch == 'arcsinh':
                stretch = 'asinh'

            if stretch == 'log':
                if vmid is None:
                    if vmin < 0:
                        raise ValueError("When using a log stretch, if vmin < 0, then vmid has to be specified")
                    else:
                        vmid = 0.
                if vmin < vmid:
                    raise ValueError("When using a log stretch, vmin should be larger than vmid")
                log_a = (vmax - vmid) / (vmin - vmid)
                norm_kwargs = {'log_a': log_a}
            elif stretch == 'asinh':
                if vmid is None:
                    vmid = vmin - (vmax - vmin) / 30.
                asinh_a = (vmid - vmin) / (vmax - vmin)
                norm_kwargs = {'asinh_a': asinh_a}
            else:
                norm_kwargs = {}

            normalizer = simple_norm(hdu.data, stretch=stretch, power=exponent,
                                     min_cut=vmin, max_cut=vmax, clip=False,
                                     **norm_kwargs)

            # Adjust vmin/vmax if auto
            if stretch == 'linear':
                vmin = -0.1 * (vmax - vmin) + vmin
            # log.info("Auto-setting vmin to %10.3e" % vmin)
            if stretch == 'linear':
                vmax = 0.1 * (vmax - vmin) + vmax
            # log.info("Auto-setting vmax to %10.3e" % vmax)
            # Update normalizer object
            normalizer.vmin = vmin
            normalizer.vmax = vmax


            targetlist = self.target_list.text()

            if len(targetlist) != 0:
                df = pd.read_csv(targetlist)
                x, y = df['RA'], df['Dec']
                target_coords = SkyCoord(x, y, unit='deg')
                x, y = wcs.world_to_pixel(target_coords)

            else:
                pass


            if len(self.field_rotation_value.text()) != 0 and len(targetlist) != 0:
                image_rotation = float(self.field_rotation_value.text())    #in degrees
                rotated_array, (x1, y1) = ndimage.rotate(hdu.data, np.array([x, y].T), image_rotation, reshape=False)

            elif len(self.field_rotation_value.text()) != 0 and len(targetlist) == 0:
                image_rotation = float(self.field_rotation_value.text())    #in degrees
                rotated_array  = ndimage.rotate(hdu.data, image_rotation, reshape=False)
                
            else:
                image_rotation = 0
                rotated_array = ndimage.rotate(hdu.data, image_rotation, reshape=False)

            

            fov_center_x = hdu.header['CRPIX1']
            fov_center_y = hdu.header['CRPIX2']

            ax.imshow(rotated_array, origin='lower',
                      cmap="gist_earth", norm=normalizer)

            if len(targetlist) != 0:
                ax.scatter(x1, y1, c='r')

            else:
                pass
            
            # Slit configuration

            fov_width = 3.1*60  # in arcsec
            delta_fov = 9.1  # in arcmin
            coord_fov = SkyCoord(coord.ra+(0/3600)*u.deg,
                                 coord.dec+(0)*u.arcsec)
                                 
                                 
            #pixel_scale = 1/(hdu.header['CDELT2']*3600) # arcsec/pixel                    
            #pix_slit_angle=0

            reg_detector = RectangleSkyRegion(coord_fov,
                                            width=delta_fov*u.arcmin,
                                            height=delta_fov*u.arcmin)
            pixel_region = reg_detector.to_pixel(wcs)
            artist = pixel_region.as_artist(color='gray', lw=1)
            ax.add_artist(artist)     
                             
                                                     
            sky_region = RectangleSkyRegion(coord_fov,
                                            width=fov_width*u.arcsec,
                                            height=delta_fov*u.arcmin)
            pixel_region = sky_region.to_pixel(wcs)
            artist = pixel_region.as_artist(color='white', lw=1)
            ax.add_artist(artist)

            c = ['r', 'tab:orange', 'yellow', 'lime', 'pink']
            slit_fov_check = []
            
            for i in range(5):
                slit0_width = float(self.tableWidget.item(0+i, 0).text())
                delta_x0 = float(self.tableWidget.item(0+i, 1).text())
                coord_slit0 = SkyCoord(coord.ra+(delta_x0/3600)*u.deg,
                                       coord.dec+9.1*(2-i)/5*u.arcmin)
                sky_region = RectangleSkyRegion(coord_slit0,
                                                width=slit0_width*u.arcsec,
                                                height=9.1/5*u.arcmin)
                pixel_region = sky_region.to_pixel(wcs)
                artist = pixel_region.as_artist(color=c[i], lw=1)
                ax.add_artist(artist)
                ax.text(0.05, 0.9-i*0.05, f'Slit {i}', transform=ax.transAxes,
                        c=c[i],  weight="bold")
                if abs(delta_x0) > fov_width/2:
                    slit_fov_check.append(delta_x0)
            
            
            if len(slit_fov_check) > 0:
                msg = QMessageBox()
                msg.setIcon(QMessageBox.Critical)
                msg.setText("Slit Out of FOV")
                msg.setInformativeText('Atleast one slit is out of FOV')
                msg.setWindowTitle("Error")
                msg.exec_()


            #ax.plot_coord(coord)
            ax.set_xlabel('Pixel')
            ax.set_ylabel('Pixel')
            ax.set_title("2MASS Image (band Ks)")
            #ax.scatter(coord.ra.value, coord.dec.value,
            #           transform=ax.get_transform('world'), marker='o',
            #           c='None', edgecolors='white', s=100)



            self.canv.draw()
            
        except:
            print("Object not found")

            msg = QMessageBox()
            msg.setIcon(QMessageBox.Critical)
            msg.setText("Error")
            msg.setInformativeText('Object could not be found or slit configuration invalid')
            msg.setWindowTitle("Error")
            msg.exec_()
    
    
    
    
    def eng_plot_table(self, vmin=None, vmid=None, vmax=None, pmin=0.25, pmax=99.75, 
                   stretch='linear', exponent=2):
   
            source_check = self.eng_textEdit.text()
            coord_check = self.eng_coords.text()
            
            if len(coord_check)!=0:
                coord_string = self.eng_coords.text()
                try:
                    coord = SkyCoord(coord_string, frame="icrs")
                    
                except:
                    coord = SkyCoord(coord_string, frame="icrs", unit=(u.hourangle, u.deg))
                    
                
                
                
            else:
                source = self.eng_textEdit.text()                           
                coord = SkyCoord.from_name(source, frame = 'icrs')
                print('Coordinates of the requested objects are: ',coord.ra, coord.dec)
    
            file_name = self.eng_textEdit_filename.text()
    
            if file_name[-5:]==".fits":
                hdu = fits.open(file_name)[0]
                wcs = WCS(hdu.header)
                
            elif file_name[-5:]==".fits" and len(source_check)==0:
                hdu = fits.open(file_name)[0]
                wcs = WCS(hdu.header)
                coord_string = self.eng_coords.text()
                coord = SkyCoord(coord_string, frame="icrs")
                
            elif len(source_check)==0 and len(coord_check)!=0 and len(file_name)==0:
                paths = SkyView.get_images(position=coord, height=10*u.arcmin,  width=10*u.arcmin,
                                        survey=['2MASS-K'])
                hdu = paths[0][0]
                wcs = WCS(hdu.header)
                
            else:    
                paths = SkyView.get_images(position=source, height=10*u.arcmin,  width=10*u.arcmin,
                                        survey=['2MASS-K'])
                hdu = paths[0][0]
                wcs = WCS(hdu.header)

            try:
                self.eng_horizontalLayout.removeWidget(self.eng_toolbar)
                self.eng_verticalLayout.removeWidget(self.eng_canv)
                sip.delete(self.eng_toolbar)
                sip.delete(self.eng_canv)
                self.eng_toolbar = None         
                self.eng_canv = None
                self.eng_verticalLayout.removeItem(self.eng_spacerItem1)
                
            except Exception as e:
                print(e)
                pass
            # self.label_6.pixmap(QtGui.QPixmap(fg))
            self.eng_canv = MatplotlibCanvas(self)
            self.eng_toolbar = Navi(self.eng_canv,self.tab_4)
            self.eng_horizontalLayout.addWidget(self.eng_toolbar)
            self.eng_verticalLayout.addWidget(self.eng_canv)
            # self.canv.axes.cla()
            self.eng_canv.fig

            eng_ax = self.eng_canv.fig.add_subplot(111)
            min_auto = vmin is None
            max_auto = vmax is None

            if min_auto or max_auto:
                interval = AsymmetricPercentileInterval(pmin, pmax,
                                                        n_samples=10000)

                try:
                    vmin_auto, vmax_auto = interval.get_limits(hdu.data)
                except (IndexError, TypeError):  # no valid values
                    vmin_auto = vmax_auto = 0

                vmin = vmin_auto
                vmax = vmax_auto

            # Prepare normalizer object
            if stretch == 'arcsinh':
                stretch = 'asinh'

            if stretch == 'log':
                if vmid is None:
                    if vmin < 0:
                        raise ValueError("When using a log stretch, if vmin < 0, then vmid has to be specified")
                    else:
                        vmid = 0.
                if vmin < vmid:
                    raise ValueError("When using a log stretch, vmin should be larger than vmid")
                log_a = (vmax - vmid) / (vmin - vmid)
                norm_kwargs = {'log_a': log_a}
            elif stretch == 'asinh':
                if vmid is None:
                    vmid = vmin - (vmax - vmin) / 30.
                asinh_a = (vmid - vmin) / (vmax - vmin)
                norm_kwargs = {'asinh_a': asinh_a}
            else:
                norm_kwargs = {}

            normalizer = simple_norm(hdu.data, stretch=stretch, power=exponent,
                                     min_cut=vmin, max_cut=vmax, clip=False,
                                     **norm_kwargs)

            # Adjust vmin/vmax if auto
            if stretch == 'linear':
                vmin = -0.1 * (vmax - vmin) + vmin
            # log.info("Auto-setting vmin to %10.3e" % vmin)
            if stretch == 'linear':
                vmax = 0.1 * (vmax - vmin) + vmax
            # log.info("Auto-setting vmax to %10.3e" % vmax)
            # Update normalizer object
            normalizer.vmin = vmin
            normalizer.vmax = vmax

            eng_ax.imshow(hdu.data, origin='lower',
                      cmap="gist_earth", norm=normalizer)
            # Slit configuration

            fov_width = 3.1*60  # in arcsec
            delta_fov = 9.1  # in arcmin
            coord_fov = SkyCoord(coord.ra+(0/3600)*u.deg,
                                 coord.dec+(0)*u.arcsec)
            sky_region = RectangleSkyRegion(coord_fov,
                                            width=fov_width*u.arcsec,
                                            height=delta_fov*u.arcmin)
            pixel_region = sky_region.to_pixel(wcs)
            artist = pixel_region.as_artist(color='white', lw=1)
            eng_ax.add_artist(artist)

            c = ['r', 'tab:orange', 'yellow', 'lime', 'pink']
            slit_fov_check = []
            
            for i in range(5):
                slit0_width = float(self.eng_tableWidget.item(0+i, 0).text())
                delta_x0 = float(self.eng_tableWidget.item(0+i, 1).text())
                coord_slit0 = SkyCoord(coord.ra+(delta_x0/3600)*u.deg,
                                       coord.dec+9.1*(2-i)/5*u.arcmin)
                sky_region = RectangleSkyRegion(coord_slit0,
                                                width=slit0_width*u.arcsec,
                                                height=9.1/5*u.arcmin)
                pixel_region = sky_region.to_pixel(wcs)
                artist = pixel_region.as_artist(color=c[i], lw=1)
                eng_ax.add_artist(artist)
                eng_ax.text(0.1, 0.9-i*0.05, f'Slit {i}', transform=eng_ax.transAxes,
                        c=c[i],  weight="bold")
                if abs(delta_x0) > fov_width/2:
                    slit_fov_check.append(delta_x0)
            
            
            if len(slit_fov_check) > 0:
                msg = QMessageBox()
                msg.setIcon(QMessageBox.Critical)
                msg.setText("Slit Out of FOV")
                msg.setInformativeText('Atleast one slit is out of FOV')
                msg.setWindowTitle("Error")
                msg.exec_()

            
            eng_ax.set_xlabel('Pixels')
            eng_ax.set_ylabel('Pixels')
            eng_ax.set_title("2MASS Image (band Ks)")


            targetlist = self.eng_target_list.text()

            if len(targetlist) != 0:
                df = pd.read_csv(targetlist)
                x, y = df['RA'], df['Dec']
                eng_ax.scatter(x, y, transform=eng_ax.get_transform('world'),
                           marker='o', c="None", edgecolors='w', s=100)

            else:
                pass

            self.eng_canv.draw()
            
    
    def grab_2MASS(self):
        source_check = self.textEdit.text()
        coord_check = self.coords.text()

        if len(coord_check) != 0:        
            paths = SkyView.get_image_list(position=coord_check, height=10*u.arcmin,  width=10*u.arcmin,
                                    survey=['2MASS-K'])
        else:
            paths = SkyView.get_image_list(position=source_check, height=10*u.arcmin,  width=10*u.arcmin,
                                    survey=['2MASS-K'])
            
        self.textEdit_filename.setText(paths[0])
        return paths


    def worker(self):
        run_thread = threading.Thread(target=self.grab_2MASS)
        run_thread.start()
        
    def start_thread(self):
        self.worker_thread.gui_text = self.textEdit_filename.text()
        self.worker_thread.start()

    def on_job_done(self, generated_str):
        print("Generated string : ", generated_str)
        self.textEdit_filename.setText(generated_str)

    
class WorkerThread(QtCore.QThread):

    job_done = QtCore.pyqtSignal('QString')

    def __init__(self, parent=None):
        super(WorkerThread, self).__init__(parent)
        self.gui_text = None

    def do_work(self):
        source_check = "SSTc2d J034432.0+321143"
        coord_check = ""

        if len(coord_check) != 0:        
            paths = SkyView.get_images(position=coord_check, height=10*u.arcmin,  width=10*u.arcmin,
                                    survey=['2MASS-K'])
        else:
            paths = SkyView.get_images(position=source_check, height=10*u.arcmin,  width=10*u.arcmin,
                                    survey=['2MASS-K'])
            
        # self.textEdit_filename.setText(paths[0])
        self.job_done.emit(paths[0])

    def run(self):
        self.do_work()


if __name__ == "__main__":
    app = QtWidgets.QApplication(sys.argv)
    w = MainWindow()
    w.show()
    sys.exit(app.exec_())
